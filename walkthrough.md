# 배포 및 테스트 가이드

`clasp push`로 코드가 업로드되었으므로, 이제 Google Apps Script를 **웹 앱(Web App)**으로 배포하고 테스트할 차례입니다.

## 1. 웹 앱 배포하기

1. 터미널에서 `clasp open`을 입력하여 Apps Script 에디터를 엽니다.
2. 우측 상단의 **[배포]** -> **[새 배포]**를 클릭합니다.
3. **유형 선택** 톱니바퀴 아이콘 -> **웹 앱**을 선택합니다.
4. 설정:
   - **설명**: `v1` (또는 원하는 설명)
   - **다음 사용자로 실행**: `나(웹 앱을 액세스하는 사용자)` -> **`나(스크립트 소유자)`** 로 변경 (중요! 시트 접근 권한 때문)
   - **액세스 권한이 있는 사용자**: **`모든 사용자`** (카카오 로그인 연동 전 테스트를 위해)
5. **[배포]** 클릭.
6. **웹 앱 URL**을 복사합니다. (예: `https://script.google.com/macros/s/.../exec`)

## 2. 동작 확인 (GET 요청)

브라우저 주소창에 복사한 **웹 앱 URL**을 붙여넣고 이동합니다.
- **성공 화면**: `Smart System Backend is Running.` 문구가 보이면 정상입니다.

## 3. 기능 테스트 (POST 요청)

터미널(PowerShell)에서 아래 명령어를 사용하여 출퇴근 시나리오를 테스트합니다.
**`[WEB_APP_URL]` 부분을 위에서 복사한 실제 URL로 바꿔주세요.**

### A. 출근 테스트 (15시 이전 가정)
```powershell
$body = @{
    action = "scan"
    id_token = "TEST_TOKEN_12345"
    ts_client = "2024-01-01T09:00:00"
    lat = 37.5
    lng = 127.0
    ua = "PowerShell Client"
} | ConvertTo-Json

Invoke-RestMethod -Uri "https://script.google.com/macros/s/AKfycbyKpeLCbtfoV6nqvYPynM7xcnTKJ2DPgIbN9RK6eaq-O4K86RJlIaXFJQG5EZXDOrlB2Q/exec" -Method Post -Body $body -ContentType "application/json"
```

### B. 퇴근 테스트 (15시 이후 가정)
서버 시간이 15시 이후라면 자동으로 퇴근으로 처리됩니다. 15시 이전이라도 로직상 15시 이후에 실행하면 퇴근 처리됩니다.

### C. 결과 확인
구글 스프레드시트(`출퇴근기록` 시트)에 데이터가 들어왔는지 확인합니다.
- `clasp open` -> 좌측 메뉴 **[개요]** -> **[스프레드시트]** 아이콘 클릭하여 이동 가능.

## 4. 트러블슈팅 (오류 해결)

만약 **"파일을 열 수 없습니다"** 또는 **"권한이 없습니다"** 오류가 발생한다면 다음 단계를 순서대로 확인해 주세요.

### 1단계: 코드가 제대로 올라갔는지 확인
1. 터미널에 `clasp open` 입력하여 스크립트 편집기 열기.
2. 좌측 파일 목록에 `Code.js`, `SheetService.js` 등이 있는지 확인.
3. 파일 내용이 비어있지 않은지 확인.
   - 만약 파일이 없거나 비어있다면: 터미널에서 `clasp push`를 다시 실행하고 페이지 새로고침.

### 2단계: 배포 버전 업데이트 (가장 흔한 원인)
코드를 수정하거나 새로 올렸다면 반드시 **새 버전**을 생성해야 합니다.
1. 우측 상단 **[배포]** -> **[배포 관리]** 클릭.
2. 기존 배포를 수정(연필 아이콘) -> **버전**을 `새로 만들기`로 선택 -> **[배포]** 클릭.
3. 또는 **[새 배포]** 버튼을 눌러 아예 새로운 배포를 생성.

### 3단계: 권한 설정 재확인
1. **[새 배포]** 시 설정 확인:
   - **다음 사용자로 실행**: `나 (Me)`
   - **액세스 권한이 있는 사용자**: `모든 사용자 (Anyone)`
2. 만약 `Google Workspace` 계정(회사 계정)이라면 `모든 사용자` 옵션이 없을 수 있습니다. 이 경우 `조직 내 모든 사용자`로 선택해야 할 수도 있습니다.

### 4단계: 테스트 배포로 확인
정식 배포 전에 **테스트 배포**로 동작을 확인할 수 있습니다.
1. **[배포]** -> **[테스트 배포]** 클릭.
2. **웹 앱 URL** (dev로 끝남) 복사.
3. 브라우저에서 접속하여 `Smart System Backend is Running.`이 뜨는지 확인.
   - 여기서 성공하면 코드는 정상이며, 정식 배포 설정(2단계, 3단계)의 문제입니다.

